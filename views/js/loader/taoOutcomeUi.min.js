define("taoOutcomeUi/plugins/results/action/view",["i18n","layout/actions/binder","core/plugin","util/url"],function(__,binder,pluginFactory,urlHelper){"use strict";return pluginFactory({name:"view",init:function init(){var resultsList=this.getHost(),action={binding:"load",url:urlHelper.route("viewResult","Results","taoOutcomeUi")};resultsList.addAction({id:"view",label:__("View"),icon:"view",action:function viewResults(id){var context={id:id,classUri:resultsList.getClassUri()};binder.exec(action,context)}})}})}),define("taoOutcomeUi/plugins/results/action/delete",["jquery","i18n","uri","core/plugin","util/url","util/encode","ui/dialog/confirm","ui/feedback"],function($,__,uri,pluginFactory,urlHelper,encode,dialogConfirm,feedback){"use strict";return pluginFactory({name:"delete",init:function init(){var resultsList=this.getHost();resultsList.addAction({id:"delete",label:__("Delete"),icon:"delete",action:function deleteResults(id){dialogConfirm(__("Please confirm deletion"),function(){$.ajax({url:urlHelper.route("delete","Results","taoOutcomeUi"),type:"POST",data:{uri:uri.encode(id)},dataType:"json"}).done(function(response){response.deleted?(feedback().success(__("Result has been deleted")),resultsList.refresh()):(feedback().error(__("Something went wrong...")+"<br>"+encode.html(response.error),{encodeHtml:!1}),resultsList.trigger("error",response.error))}).fail(function(err){feedback().error(__("Something went wrong...")),resultsList.trigger("error",err)})})}})}})}),define("taoOutcomeUi/plugins/results/action/download",["jquery","i18n","core/plugin","util/url","jquery.fileDownload"],function($,__,pluginFactory,urlHelper){"use strict";return pluginFactory({name:"download",init:function init(){var resultsList=this.getHost();resultsList.addAction({id:"download",label:__("Export Results"),icon:"export",action:function downloadResults(id){$.fileDownload(urlHelper.route("downloadXML","Results","taoOutcomeUi"),{failMessageHtml:__("Unexpected error occurred when generating your report. Please contact your system administrator."),httpMethod:"GET",data:{id:id,delivery:resultsList.getClassUri()}})}})}})}),define("taoOutcomeUi/component/results/pluginsLoader",["core/pluginLoader","taoOutcomeUi/plugins/results/action/view","taoOutcomeUi/plugins/results/action/delete","taoOutcomeUi/plugins/results/action/download"],function(pluginLoader,actionView,actionDelete,actionDownload){"use strict";return pluginLoader({action:[actionView,actionDelete,actionDownload]})}),define("taoOutcomeUi/component/results/areaBroker",["ui/areaBroker"],function(areaBroker){"use strict";var requireAreas=["list"];return areaBroker.bind(null,requireAreas)}),define("tpl!taoOutcomeUi/component/results/list",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},"<div class=\"component results-list\">\n    <div class=\"list\"></div>\n</div>"})}),define("taoOutcomeUi/component/results/list",["jquery","i18n","lodash","uri","core/promise","ui/component","taoOutcomeUi/component/results/areaBroker","tpl!taoOutcomeUi/component/results/list","ui/datatable"],function($,__,_,uri,Promise,component,resultsAreaBroker,listTpl){"use strict";function resultsListFactory(config,pluginFactories){function pluginRun(method){var execStack=[];return _.forEach(plugins,function(plugin){"function"==typeof plugin[method]&&execStack.push(plugin[method]())}),Promise.all(execStack)}var resultsList,areaBroker,classUri,plugins={},actions=[];if(!_.isPlainObject(config))throw new TypeError("The configuration is required");if("string"!=typeof config.classUri||!config.classUri)throw new TypeError("The class URI is required");if("string"!=typeof config.dataUrl||!config.dataUrl)throw new TypeError("The service URL is required");if(!_.isPlainObject(config.model)&&!_.isArray(config.model))throw new TypeError("The data model is required");return classUri=uri.decode(config.classUri),resultsList=component({refresh:function refresh(){return areaBroker.getListArea().datatable("refresh"),this},addAction:function addAction(name,action){var descriptor;return _.isPlainObject(name)?descriptor=name:_.isPlainObject(action)?(descriptor=action,action.id=name):descriptor={id:name,label:name},"function"==typeof action&&(descriptor.action=action),descriptor.label||(descriptor.label=descriptor.id),actions.push(descriptor),this},getConfig:function getConfig(){return this.config},getClassUri:function getClassUri(){return classUri},getActions:function getActions(){return actions}}),resultsList.before("render",function onRender(){var self=this;return areaBroker=resultsAreaBroker(this.$component,{list:$(".list",this.$component)}),_.forEach(pluginFactories,function(pluginFactory){var plugin=pluginFactory(self,areaBroker);plugins[plugin.getName()]=plugin}),pluginRun("init").then(function(){return pluginRun("render")}).then(function(){areaBroker.getListArea().empty().on("query.datatable",function(){self.setState("loading",!0).trigger("loading")}).on("load.datatable",function(){self.setState("loading",!1).trigger("loaded")}).datatable({url:self.config.dataUrl,model:self.config.model,actions:actions,filter:self.config.searchable,labels:{filter:__("Search by delivery results")},sortby:"timestamp",sortorder:"desc"})}).catch(function(err){return self.trigger("error",err),Promise.reject(err)})}).before("destroy",function onDestroy(){var self=this;return pluginRun("destroy").then(function(){areaBroker.getListArea().empty()}).catch(function(err){self.trigger("error",err)})}).setTemplate(listTpl).init(config)}return resultsListFactory}),define("taoOutcomeUi/controller/inspectResults",["jquery","lodash","i18n","module","core/logger","core/dataProvider/request","util/url","layout/actions/binder","layout/loading-bar","ui/feedback","ui/taskQueue/taskQueue","taoOutcomeUi/component/results/pluginsLoader","taoOutcomeUi/component/results/list","ui/taskQueueButton/treeButton"],function($,_,__,module,loggerFactory,request,urlHelper,binder,loadingBar,feedback,taskQueue,resultsPluginsLoader,resultsListFactory,treeTaskButtonFactory){"use strict";function reportError(err){loadingBar.stop(),logger.error(err),err instanceof Error&&feedback().error(err.message)}const logger=loggerFactory("controller/inspectResults");return{start:function(){const config=module.config()||{},$container=$("#inspect-result"),classUri=$container.data("uri"),searchContainer=$(".action-bar .search-area");if(searchContainer.data("show-result")){const action={binding:"load",url:urlHelper.route("viewResult","Results","taoOutcomeUi")},context={id:searchContainer.data("show-result"),classUri};return searchContainer.removeData("show-result"),void binder.exec(action,context)}const listConfig={dataUrl:urlHelper.route("getResults","Results","taoOutcomeUi",{classUri:classUri}),model:config.dataModel,searchable:config.searchable,classUri:classUri};let taskButton,taskButtonExportSQL;loadingBar.start(),_.forEach(config.plugins,function(plugin){plugin&&plugin.module&&(plugin.exclude?resultsPluginsLoader.remove(plugin.module):resultsPluginsLoader.add(plugin))}),$container.length?resultsPluginsLoader.load().then(function(){resultsListFactory(listConfig,resultsPluginsLoader.getPlugins()).on("error",reportError).on("success",function(message){feedback().success(message)}).before("loading",function(){loadingBar.start()}).after("loaded",function(){loadingBar.stop()}).render($(".inspect-results-grid",$container))}).catch(reportError):loadingBar.stop(),taskButton=treeTaskButtonFactory({replace:!0,icon:"export",label:__("Export CSV"),taskQueue:taskQueue}).render($("#results-csv-export")),binder.register("export_csv",function remove(actionContext){const data=(_ref=>{let{uri,classUri,id}=_ref;return{uri,classUri,id}})(actionContext),uniqueValue=data.uri||data.classUri||"";taskButton.setTaskConfig({taskCreationUrl:this.url,taskCreationData:{uri:uniqueValue}}).start()}),$("#results-sql-export").length&&(taskButtonExportSQL=treeTaskButtonFactory({replace:!0,icon:"export",label:__("Export SQL"),taskQueue:taskQueue}).render($("#results-sql-export")),binder.register("export_sql",function remove(actionContext){const data=(_ref2=>{let{uri,classUri,id}=_ref2;return{uri,classUri,id}})(actionContext),uniqueValue=data.uri||data.classUri||"";taskButtonExportSQL.setTaskConfig({taskCreationUrl:this.url,taskCreationData:{uri:uniqueValue}}).start()})),binder.register("open_url",function(actionContext){const data=(_ref3=>{let{uri,classUri,id}=_ref3;return{uri,classUri,id}})(actionContext);request(this.url,data,"POST").then(response=>{const url=response.url;url?window.open(url,"_blank"):feedback().info(__("The URL does not exist."))}).catch(reportError)})}}}),define("tpl!taoOutcomeUi/controller/resultModal",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},"<div class=\"modal results-modal\">\n\n</div>"})}),define("taoOutcomeUi/controller/resultsMonitoring",["jquery","lodash","i18n","util/url","uri","ui/feedback","util/locale","util/encode","layout/loading-bar","layout/actions/binder","ui/dialog/confirm","tpl!taoOutcomeUi/controller/resultModal","ui/datatable"],function($,_,__,url,uri,feedback,locale,encode,loadingBar,binder,dialogConfirm,resultModalTpl){"use strict";function getNumRows(){var lineHeight=30,searchPagination=70,$upperElem=$(".content-container h2"),topSpace=$upperElem.offset().top+$upperElem.height()+parseInt($upperElem.css("margin-bottom"),10)+30+searchPagination,availableHeight=$window.height()-topSpace-$("footer.dark-bar").outerHeight();return window.MSInputMethodContext||document.documentMode||window.StyleMedia?Math.min(Math.floor(availableHeight/30),25):25}function getRequestErrorMessage(xhr){loadingBar.start();var message="";try{var responseJSON=$.parseJSON(xhr.responseText);message=responseJSON.message?responseJSON.message:xhr.responseText}catch(e){message=xhr.responseText}return message}function viewResult(rowId){var res=parseRowId(rowId);loadingBar.start(),$.ajax({url:url.route("viewResult","Results","taoOutcomeUi",{id:res[0],classUri:res[1]}),type:"GET",success:function(result){var $container=$(resultModalTpl()).append(result);$resultsListContainer.append($container),$container.modal({startClosed:!1,minWidth:450,top:50}),$container.css({"max-height":$window.height()-80+"px",overflow:"auto"}),$container.on("click",function(e){var $target=$(e.target),$element=null;if($target.is("a")&&$target.hasClass("preview")?$element=$target:$target.is("span")&&$target.parent().hasClass("preview")&&($element=$target.parent()),$element){var $modalContainer=$element.parents(".modal");$modalContainer.length&&$modalContainer.trigger("closed.modal"),$(".preview-overlay").css({zIndex:$container.modal().css("z-index")+1})}}),$container.on("closed.modal",function(){$container.modal("destroy"),$(".modal-bg").remove(),$(this).remove()}),loadingBar.stop()},error:function(xhr,err){var message=getRequestErrorMessage(xhr);feedback().error(message,{encodeHtml:!1}),loadingBar.stop()}})}function checkValidItem(){return!this.start_time}function downloadResult(rowId){var res=parseRowId(rowId);$.fileDownload(url.route("downloadXML","Results","taoOutcomeUi"),{failMessageHtml:__("Unexpected error occurred when generating your report. Please contact your system administrator."),httpMethod:"GET",data:{id:res[0],delivery:res[1]}})}function parseRowId(rowId){return rowId.split("|")}var $resultsListContainer=$(".results-list-container"),$window=$(window);return{start:function(){var $contentBlock=$resultsListContainer.parents(".content-block"),resizeContainer=function(){var padding=$contentBlock.innerHeight()-$contentBlock.height();$contentBlock.height($window.height()-$("footer.dark-bar").outerHeight()-$("header.dark-bar").outerHeight()-$(".tab-container").outerHeight()-$(".action-bar.content-action-bar").outerHeight()-padding)};$window.on("resize",_.debounce(resizeContainer,300)),resizeContainer(),$resultsListContainer.datatable({url:url.route("data","ResultsMonitoring","taoOutcomeUi"),filter:!0,labels:{filter:__("Search by results")},model:[{id:"delivery",label:__("Delivery"),sortable:!1},{id:"deliveryResultIdentifier",label:__("Delivery Execution"),sortable:!1},{id:"userName",label:__("Test Taker"),sortable:!1},{id:"start_time",label:__("Start Time"),sortable:!1}],paginationStrategyTop:"simple",paginationStrategyBottom:"pages",rows:getNumRows(),sortby:"result_id",sortorder:"desc",actions:{view:{id:"view",label:__("View"),icon:"external",action:viewResult,disabled:checkValidItem},download:{id:"download",title:__("Download result"),icon:"download",label:__("Download"),action:downloadResult,disabled:checkValidItem}}})}}}),define("taoOutcomeUi/controller/resultTable",["jquery","lodash","i18n","module","util/url","ui/feedback","ui/taskQueue/taskQueue","ui/taskQueueButton/standardButton","ui/dateRange/dateRange","layout/loading-bar","ui/datatable"],function($,_,__,module,urlUtil,feedback,taskQueue,standardTaskButtonFactory,dateRangeFactory,loadingBar){"use strict";var resulTableController={start:function start(){var conf=module.config(),$container=$(".result-table"),$filterField=$(".result-filter",$container),$filterButtonsContainer=$(".filter-buttons",$container),$tableContainer=$(".result-table-container",$container),$dateStartRangeContainer=$(".de-start-range",$container),$dateEndRangeContainer=$(".de-end-range",$container),filter=conf.filter||"lastSubmitted",deStartFrom="",deStartTo="",deEndFrom="",deEndTo="",uri=conf.uri||"",columns=[],groups={},filterDeStartRange=dateRangeFactory($dateStartRangeContainer,{startPicker:{setup:"datetime",format:"YYYY-MM-DD HH:mm:ss",field:{name:"periodStart"}},endPicker:{setup:"datetime",format:"YYYY-MM-DD HH:mm:ss",field:{name:"periodEnd"}}}).on("change",function(v){console.log("changed",v)}).on("render",function(){$("button",$dateStartRangeContainer).hide()}),filterDeEndRange=dateRangeFactory($dateEndRangeContainer,{startPicker:{setup:"datetime",format:"YYYY-MM-DD HH:mm:ss",field:{name:"periodStart"}},endPicker:{setup:"datetime",format:"YYYY-MM-DD HH:mm:ss",field:{name:"periodEnd"}}}).on("render",function(){$("button",$dateEndRangeContainer).hide()}),buildGrid=function buildGrid(url,action,done){loadingBar.start(),$.ajax({url:url,dataType:"json",data:{filter:filter,uri:uri},type:"GET"}).done(function(response){response&&response.columns&&("remove"===action?columns=columns.filter(col=>!response.columns.some(resCol=>_.isEqual(col,resCol))):"undefined"!=typeof response.first&&!0===response.first?columns=response.columns.concat(columns):columns=columns.concat(response.columns)),"function"==typeof done&&done()}).always(function(){loadingBar.stop()})},_buildTable=function _buildTable(done){var model=[];_.forEach(columns,function(col){var colId=col.prop?col.prop+"_"+col.contextType:col.contextId+"_"+col.variableIdentifier;col.columnId&&(colId=col.columnId),model.push({id:colId,label:col.label,sortable:!1})}),$tableContainer.empty().data("ui.datatable",null).off("load.datatable").on("load.datatable",function(){"function"==typeof done&&(done(),done="")}).datatable({url:urlUtil.route("feedDataTable","ResultTable","taoOutcomeUi",{filter:filter,startfrom:deStartFrom,startto:deStartTo,endfrom:deEndFrom,endto:deEndTo}),querytype:"POST",params:{columns:JSON.stringify(columns),_search:!1,uri:uri},model:model})},filterChanged=function filterChanged(){filter=$filterField.select2("val"),deStartFrom=filterDeStartRange.getStart(),deStartTo=filterDeStartRange.getEnd(),deEndFrom=filterDeEndRange.getStart(),deEndTo=filterDeEndRange.getEnd(),_buildTable()};$("[data-group]",$container).each(function(){var $elt=$(this),group=$elt.data("group"),action=$elt.data("action");groups[group]=groups[group]||{},groups[group][action]=$elt}),$container.on("click","[data-group]",function(e){var $elt=$(this),group=$elt.data("group"),action=$elt.data("action"),url=$elt.data("url");e.preventDefault(),buildGrid(url,action,function(){_.forEach(groups[group],function($btn){$btn.toggleClass("hidden")})})}),buildGrid(urlUtil.route("getTestTakerColumns","ResultTable","taoOutcomeUi",{filter:filter})),$filterField.select2({minimumResultsForSearch:-1}).select2("val",filter),$(".result-filter-btn",$container).click(function(){filterChanged()}),standardTaskButtonFactory({type:"info",icon:"export",title:__("Export CSV File"),label:__("Export CSV File"),taskQueue:taskQueue,taskCreationUrl:urlUtil.route("export","ResultTable","taoOutcomeUi"),taskCreationData:function getTaskRequestData(){return{filter:filter,columns:JSON.stringify(columns),uri:uri,startfrom:deStartFrom,startto:deStartTo,endfrom:deEndFrom,endto:deEndTo}}}).on("error",function(err){feedback().error(err)}).render($filterButtonsContainer),conf.allowSqlExport&&standardTaskButtonFactory({type:"info",icon:"export",title:__("Export SQL File"),label:__("Export SQL File"),taskQueue:taskQueue,taskCreationUrl:urlUtil.route("exportSQL","ResultTable","taoOutcomeUi"),taskCreationData:function getTaskRequestData(){return filterChanged(),{filter:filter,columns:JSON.stringify(columns),uri:uri,startfrom:deStartFrom,startto:deStartTo,endfrom:deEndFrom,endto:deEndTo}}}).on("error",function(err){feedback().error(err)}).render($filterButtonsContainer)}};return resulTableController}),define("taoOutcomeUi/controller/routes",[],function(){"use strict";return{Results:{actions:{viewResult:"controller/viewResult",index:"controller/inspectResults"}},ResultTable:{actions:{index:"controller/resultTable"}},ResultsMonitoring:{actions:{index:"controller/resultsMonitoring"}}}}),define("taoOutcomeUi/controller/viewResult",["module","jquery","i18n","util/url","core/logger","core/request","layout/section","taoItems/previewer/factory","ui/dialog/confirm","uri","ui/feedback","core/router","jquery.fileDownload"],function(module,$,__,urlHelper,loggerFactory,request,section,previewerFactory,dialogConfirm,uriHelper,feedback,router){"use strict";function requestFileContent(variableUri,deliveryUri){return request({url:dataUrl,method:"POST",data:{variableUri,deliveryUri}}).then(response=>{const{data,name,mime}=response;return{data,name,mime}})}function refineFileResponse(response,deliveryUri){const{file}=response&&response.base||{};return file&&file.uri&&!file.data?requestFileContent(file.uri,deliveryUri).then(fileData=>{fileData&&fileData.data?response.base.file=fileData:response.base=null}).catch(e=>logger.error(e)):Promise.resolve()}function refineItemState(state,deliveryUri){if(!state)return Promise.resolve(state);const filePromises=Object.keys(state).map(identifier=>{const{response}=state[identifier];return refineFileResponse(response,deliveryUri)});return Promise.all(filePromises).then(()=>state)}const logger=loggerFactory("taoOutcomeUi/viewResults"),downloadUrl=urlHelper.route("getFile","Results","taoOutcomeUi"),dataUrl=urlHelper.route("getVariableFile","Results","taoOutcomeUi"),viewResultController={start(){const conf=module.config(),deliveryUri=conf.classUri,$container=$("#view-result"),$resultFilterField=$(".result-filter",$container),$classFilterField=$("[name=\"class-filter\"]",$container);let classFilter=JSON.parse(conf.filterTypes)||[];for(let i in $resultFilterField.select2({minimumResultsForSearch:-1}).select2("val",conf.filterSubmission||"all"),classFilter)$(`[value = "${classFilter[i]}"]`).prop("checked","checked");$(".result-filter-btn",$container).click(()=>{classFilter=[""],$classFilterField.each(function(){$(this).prop("checked")&&classFilter.push($(this).val())}),section.loadContentBlock(urlHelper.route("viewResult","Results","taoOutcomeUi"),{id:conf.id,classUri:conf.classUri,filterSubmission:$resultFilterField.select2("val"),filterTypes:classFilter})}),$("#xmlDownload",$container).on("click",function(){$.fileDownload(urlHelper.route("downloadXML","Results","taoOutcomeUi"),{failMessageHtml:__("Unexpected error occurred when generating your report. Please contact your system administrator."),httpMethod:"GET",data:{id:conf.id,delivery:conf.classUri}})}),$("[id^=fileDownload]",$container).on("click",function(){const variableUri=$(this).val();$.fileDownload(downloadUrl,{httpMethod:"POST",data:{variableUri,deliveryUri}})}),$(".delete",$container).on("click",function(){dialogConfirm(__("Please confirm deletion"),function(){$.ajax({url:urlHelper.route("delete","Results","taoOutcomeUi"),type:"POST",data:{uri:uriHelper.encode(conf.id)},dataType:"json"}).done(function(response){response.deleted?(feedback().success(__("Result has been deleted")),router.dispatch("tao/Main/index")):feedback().error(__("Something went wrong...")+"<br>"+encode.html(response.error),{encodeHtml:!1})}).fail(function(){feedback().error(__("Something went wrong..."))})})}),$(".print",$container).on("click",function(){window.print()}),$(".preview",$container).on("click",function(e){const $btn=$(this),deliveryId=$btn.data("deliveryId"),resultId=$btn.data("resultId"),itemDefinition=$btn.data("definition");let uri=$btn.data("uri");const type=$btn.data("type");e.preventDefault(),$btn.prop("disabled")||($btn.prop("disabled",!0).addClass("disabled"),deliveryId&&resultId&&itemDefinition&&(uri={uri:uri,resultId:resultId,itemDefinition:itemDefinition,deliveryUri:deliveryId}),Promise.resolve($btn.data("state")).then(state=>refineItemState(state,deliveryUri)).then(state=>{$btn.removeProp("disabled").removeClass("disabled"),previewerFactory(type,uri,state,{view:"reviewRenderer",fullPage:!0})}).catch(err=>logger.error(err)))})}};return viewResultController}),define("taoOutcomeUi/loader/taoOutcomeUi.bundle",function(){}),define("taoOutcomeUi/loader/taoOutcomeUi.min",["taoItems/loader/taoItems.min"],function(){});
//# sourceMappingURL=taoOutcomeUi.min.js.map