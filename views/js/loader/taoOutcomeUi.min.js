define("taoOutcomeUi/plugins/results/action/view",["i18n","layout/actions/binder","core/plugin","util/url"],function(__,binder,pluginFactory,urlHelper){"use strict";return pluginFactory({name:"view",init:function(){var resultsList=this.getHost(),action={binding:"load",url:urlHelper.route("viewResult","Results","taoOutcomeUi")};resultsList.addAction({id:"view",label:__("View"),icon:"view",action:function(id){var context={id:id,classUri:resultsList.getClassUri()};binder.exec(action,context)}})}})}),define("taoOutcomeUi/plugins/results/action/delete",["jquery","i18n","uri","core/plugin","util/url","util/encode","ui/dialog/confirm","ui/feedback"],function($,__,
uri,pluginFactory,urlHelper,encode,dialogConfirm,feedback){"use strict";return pluginFactory({name:"delete",init:function(){var resultsList=this.getHost();resultsList.addAction({id:"delete",label:__("Delete"),icon:"delete",action:function(id){dialogConfirm(__("Please confirm deletion"),function(){$.ajax({url:urlHelper.route("delete","Results","taoOutcomeUi"),type:"POST",data:{uri:uri.encode(id)},dataType:"json"}).done(function(response){response.deleted?(feedback().success(__("Result has been deleted")),resultsList.refresh()):(feedback().error(__("Something went wrong...")+"<br>"+encode.html(response.error),{encodeHtml:!1}),resultsList.trigger("error",
response.error))}).fail(function(err){feedback().error(__("Something went wrong...")),resultsList.trigger("error",err)})})}})}})}),define("taoOutcomeUi/plugins/results/action/download",["jquery","i18n","core/plugin","util/url","jquery.fileDownload"],function($,__,pluginFactory,urlHelper){"use strict";return pluginFactory({name:"download",init:function(){var resultsList=this.getHost();resultsList.addAction({id:"download",label:__("Download"),icon:"download",action:function(id){$.fileDownload(urlHelper.route("downloadXML","Results","taoOutcomeUi"),{preparingMessageHtml:__("We are preparing your report, please wait..."),failMessageHtml:__(
"There was a problem generating your report, please try again."),httpMethod:"GET",data:{id:id,delivery:resultsList.getClassUri()}})}})}})}),define("taoOutcomeUi/component/results/pluginsLoader",["core/pluginLoader","taoOutcomeUi/plugins/results/action/view","taoOutcomeUi/plugins/results/action/delete","taoOutcomeUi/plugins/results/action/download"],function(pluginLoader,actionView,actionDelete,actionDownload){"use strict";return pluginLoader({action:[actionView,actionDelete,actionDownload]})}),define("taoOutcomeUi/component/results/areaBroker",["lodash","core/areaBroker"],function(_,areaBroker){"use strict";return _.partial(areaBroker,["list"])}),define(
"tpl!taoOutcomeUi/component/results/list",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},'<div class="component results-list">\n    <div class="list"></div>\n</div>'})}),define("taoOutcomeUi/component/results/list",["jquery","i18n","lodash","uri","core/promise","ui/component","taoOutcomeUi/component/results/areaBroker","tpl!taoOutcomeUi/component/results/list","ui/datatable"],function($,__,_,uri,Promise,component,resultsAreaBroker,listTpl){"use strict";return function(config,pluginFactories){var areaBroker,
classUri,plugins={},actions=[];function pluginRun(method){var execStack=[];return _.forEach(plugins,function(plugin){_.isFunction(plugin[method])&&execStack.push(plugin[method]())}),Promise.all(execStack)}if(!_.isPlainObject(config))throw new TypeError("The configuration is required");if(!_.isString(config.classUri)||!config.classUri)throw new TypeError("The class URI is required");if(!_.isString(config.dataUrl)||!config.dataUrl)throw new TypeError("The service URL is required");if(!_.isPlainObject(config.model)&&!_.isArray(config.model))throw new TypeError("The data model is required");return classUri=uri.decode(config.classUri),component({refresh:function(
){return areaBroker.getListArea().datatable("refresh"),this},addAction:function(name,action){var descriptor;return _.isPlainObject(name)?descriptor=name:_.isPlainObject(action)?(descriptor=action).id=name:descriptor={id:name,label:name},_.isFunction(action)&&(descriptor.action=action),descriptor.label||(descriptor.label=descriptor.id),actions.push(descriptor),this},getConfig:function(){return this.config},getClassUri:function(){return classUri},getActions:function(){return actions}}).before("render",function(){var self=this;return areaBroker=resultsAreaBroker(this.$component,{list:$(".list",this.$component)}),_.forEach(pluginFactories,function(pluginFactory
){var plugin=pluginFactory(self,areaBroker);plugins[plugin.getName()]=plugin}),pluginRun("init").then(function(){return pluginRun("render")}).then(function(){areaBroker.getListArea().empty().on("query.datatable",function(){self.setState("loading",!0).trigger("loading")}).on("load.datatable",function(){self.setState("loading",!1).trigger("loaded")}).datatable({url:self.config.dataUrl,model:self.config.model,actions:actions,filter:self.config.searchable,labels:{filter:__("Search by delivery results")}})}).catch(function(err){return self.trigger("error",err),Promise.reject(err)})}).before("destroy",function(){var self=this;return pluginRun("destroy").then(
function(){areaBroker.getListArea().empty()}).catch(function(err){self.trigger("error",err)})}).setTemplate(listTpl).init(config)}}),define("taoOutcomeUi/controller/inspectResults",["jquery","lodash","i18n","module","core/logger","util/url","layout/actions/binder","layout/loading-bar","ui/feedback","core/taskQueue/taskQueue","taoOutcomeUi/component/results/pluginsLoader","taoOutcomeUi/component/results/list","ui/taskQueueButton/treeButton"],function($,_,__,module,loggerFactory,urlHelper,binder,loadingBar,feedback,taskQueue,resultsPluginsLoader,resultsListFactory,treeTaskButtonFactory){"use strict";var logger=loggerFactory("controller/inspectResults")
;function reportError(err){loadingBar.stop(),logger.error(err),err instanceof Error&&feedback().error(err.message)}return{start:function(){var taskButton,config=module.config()||{},$container=$("#inspect-result"),classUri=$container.data("uri"),listConfig={dataUrl:urlHelper.route("getResults","Results","taoOutcomeUi",{classUri:classUri}),model:config.dataModel,searchable:config.searchable,classUri:classUri};loadingBar.start(),_.forEach(config.plugins,function(plugin){plugin&&plugin.module&&(plugin.exclude?resultsPluginsLoader.remove(plugin.module):resultsPluginsLoader.add(plugin))}),$container.length?resultsPluginsLoader.load().then(function(){
resultsListFactory(listConfig,resultsPluginsLoader.getPlugins()).on("error",reportError).on("success",function(message){feedback().success(message)}).before("loading",function(){loadingBar.start()}).after("loaded",function(){loadingBar.stop()}).render($(".inspect-results-grid",$container))}).catch(reportError):loadingBar.stop(),taskButton=treeTaskButtonFactory({replace:!0,icon:"export",label:__("Export CSV"),taskQueue:taskQueue}).render($("#results-csv-export")),binder.register("export_csv",function(actionContext){var data=_.pick(actionContext,["uri","classUri","id"]),uniqueValue=data.uri||data.classUri||"";taskButton.setTaskConfig({taskCreationUrl:this.url,
taskCreationData:{uri:uniqueValue}}).start()})}}}),define("tpl!taoOutcomeUi/controller/resultModal",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){return this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{},'<div class="modal results-modal">\n\n</div>'})}),define("taoOutcomeUi/controller/resultsMonitoring",["jquery","lodash","i18n","util/url","uri","ui/feedback","util/locale","util/encode","layout/loading-bar","layout/actions/binder","ui/dialog/confirm","tpl!taoOutcomeUi/controller/resultModal","ui/datatable"],function($,_,__,url,uri,feedback,locale,encode,loadingBar,
binder,dialogConfirm,resultModalTpl){"use strict";var $resultsListContainer=$(".results-list-container"),$window=$(window);function viewResult(rowId){var res=parseRowId(rowId);loadingBar.start(),$.ajax({url:url.route("viewResult","Results","taoOutcomeUi",{id:res[0],classUri:res[1]}),type:"GET",success:function(result){var $container=$(resultModalTpl()).append(result);$resultsListContainer.append($container),$container.modal({startClosed:!1,minWidth:450,top:50}),$container.css({"max-height":$window.height()-80+"px",overflow:"auto"}),$container.on("click",function(e){var $target=$(e.target),$element=null;if($target.is("a")&&$target.hasClass("preview"
)?$element=$target:$target.is("span")&&$target.parent().hasClass("preview")&&($element=$target.parent()),$element){var $modalContainer=$element.parents(".modal");$modalContainer.length&&$modalContainer.trigger("closed.modal"),$(".preview-overlay").css({zIndex:$container.modal().css("z-index")+1})}}),$container.on("closed.modal",function(){$container.modal("destroy"),$(".modal-bg").remove(),$(this).remove()}),loadingBar.stop()},error:function(xhr,err){var message=function(xhr){loadingBar.start();var message="";try{var responseJSON=$.parseJSON(xhr.responseText);message=responseJSON.message?responseJSON.message:xhr.responseText}catch(e){message=xhr.responseText
}return message}(xhr);feedback().error(message,{encodeHtml:!1}),loadingBar.stop()}})}function checkValidItem(){return!this.start_time}function downloadResult(rowId){var res=parseRowId(rowId);$.fileDownload(url.route("downloadXML","Results","taoOutcomeUi"),{preparingMessageHtml:__("We are preparing your report, please wait..."),failMessageHtml:__("There was a problem generating your report, please try again."),httpMethod:"GET",data:{id:res[0],delivery:res[1]}})}function parseRowId(rowId){return rowId.split("|")}return{start:function(){var $upperElem,topSpace,availableHeight,$contentBlock=$resultsListContainer.parents(".content-block"),
resizeContainer=function(){var padding=$contentBlock.innerHeight()-$contentBlock.height();$contentBlock.height($window.height()-$("footer.dark-bar").outerHeight()-$("header.dark-bar").outerHeight()-$(".tab-container").outerHeight()-$(".action-bar.content-action-bar").outerHeight()-padding)};$window.on("resize",_.debounce(resizeContainer,300)),resizeContainer(),$resultsListContainer.datatable({url:url.route("data","ResultsMonitoring","taoOutcomeUi"),filter:!0,labels:{filter:__("Search by results")},model:[{id:"delivery",label:__("Delivery"),sortable:!1},{id:"deliveryResultIdentifier",label:__("Delivery Execution"),sortable:!1},{id:"testTakerIdentifier",
label:__("Test Taker"),sortable:!1},{id:"start_time",label:__("Start Time"),sortable:!1}],paginationStrategyTop:"simple",paginationStrategyBottom:"pages",rows:($upperElem=$(".content-container h2"),topSpace=$upperElem.offset().top+$upperElem.height()+parseInt($upperElem.css("margin-bottom"),10)+30+70,availableHeight=$window.height()-topSpace-$("footer.dark-bar").outerHeight(),window.MSInputMethodContext||document.documentMode||window.StyleMedia?Math.min(Math.floor(availableHeight/30),25):25),sortby:"result_id",sortorder:"desc",actions:{view:{id:"view",label:__("View"),icon:"external",action:viewResult,disabled:checkValidItem},download:{id:"download",
title:__("Download result"),icon:"download",label:__("Download"),action:downloadResult,disabled:checkValidItem}}})}}}),define("taoOutcomeUi/controller/resultTable",["jquery","lodash","i18n","module","util/url","ui/feedback","core/taskQueue/taskQueue","ui/taskQueueButton/standardButton","ui/datatable"],function($,_,__,module,urlUtil,feedback,taskQueue,standardTaskButtonFactory){"use strict";return{start:function(){var conf=module.config(),$container=$(".result-table"),$filterField=$(".result-filter",$container),$tableContainer=$(".result-table-container",$container),filter=conf.filter||"lastSubmitted",uri=conf.uri||"",columns=[],groups={},
$actionBar=$container.find(".actions"),buildGrid=function(url,action,done){$.ajax({url:url,dataType:"json",data:{filter:filter,uri:uri},type:"GET"}).done(function(response){response&&response.columns&&(columns="remove"===action?_.reject(columns,function(col){return _.find(response.columns,function(resCol){return _.isEqual(col,resCol)})}):void 0!==response.first&&!0===response.first?response.columns.concat(columns):columns.concat(response.columns),_buildTable(done))})},_buildTable=function(done){var model=[];_.forEach(columns,function(col){model.push({id:col.prop?col.prop+"_"+col.contextType:col.contextId+"_"+col.variableIdentifier,label:col.label,sortable:!1
})}),$tableContainer.empty().data("ui.datatable",null).off("load.datatable").on("load.datatable",function(){_.isFunction(done)&&(done(),done="")}).datatable({url:urlUtil.route("feedDataTable","ResultTable","taoOutcomeUi",{filter:filter}),querytype:"POST",params:{columns:JSON.stringify(columns),_search:!1,uri:uri},model:model})};$("[data-group]",$container).each(function(){var $elt=$(this),group=$elt.data("group"),action=$elt.data("action");groups[group]=groups[group]||{},groups[group][action]=$elt}),$container.on("click","[data-group]",function(e){var $elt=$(this),group=$elt.data("group"),action=$elt.data("action"),url=$elt.data("url");e.preventDefault(),
buildGrid(url,action,function(){_.forEach(groups[group],function($btn){$btn.toggleClass("hidden")})})}),buildGrid(urlUtil.route("getTestTakerColumns","ResultTable","taoOutcomeUi",{filter:filter})),$filterField.select2({minimumResultsForSearch:-1}).select2("val",filter),$(".result-filter-btn",$container).click(function(){filter=$filterField.select2("val"),_buildTable()}),standardTaskButtonFactory({type:"info",icon:"export",title:__("Export CSV File"),label:__("Export CSV File"),taskQueue:taskQueue,taskCreationUrl:urlUtil.route("export","ResultTable","taoOutcomeUi"),taskCreationData:function(){return{filter:filter,columns:JSON.stringify(columns),uri:uri}}}
).on("error",function(err){feedback().error(err)}).render($actionBar)}}}),define("taoOutcomeUi/controller/routes",[],function(){"use strict";return{Results:{actions:{viewResult:"controller/viewResult",index:"controller/inspectResults"}},ResultTable:{actions:{index:"controller/resultTable"}},ResultsMonitoring:{actions:{index:"controller/resultsMonitoring"}}}}),define("taoOutcomeUi/controller/viewResult",["module","jquery","i18n","util/url","layout/section","taoItems/previewer/factory","jquery.fileDownload"],function(module,$,__,urlHelper,section,previewerFactory){"use strict";return{start:function(){var conf=module.config(),$container=$("#view-result"),
$resultFilterField=$(".result-filter",$container),$classFilterField=$('[name="class-filter"]',$container),classFilter=JSON.parse(conf.filterTypes)||[];for(var i in $resultFilterField.select2({minimumResultsForSearch:-1}).select2("val",conf.filterSubmission||"all"),classFilter)$('[value="'+classFilter[i]+'"]').prop("checked","checked");$(".result-filter-btn",$container).click(function(e){classFilter=[""],$classFilterField.each(function(){$(this).prop("checked")&&classFilter.push($(this).val())}),section.loadContentBlock(urlHelper.route("viewResult","Results","taoOutcomeUi"),{id:conf.id,classUri:conf.classUri,filterSubmission:$resultFilterField.select2("val"),
filterTypes:classFilter})}),$(".download",$container).on("click",function(e){var variableUri=$(this).val();$.fileDownload(urlHelper.route("getFile","Results","taoOutcomeUi"),{preparingMessageHtml:__("We are preparing your report, please wait..."),failMessageHtml:__("There was a problem generating your report, please try again."),httpMethod:"POST",data:{variableUri:variableUri,deliveryUri:conf.classUri}})}),$(".preview",$container).on("click",function(e){var $this=$(this),deliveryId=$this.data("deliveryId"),resultId=$this.data("resultId"),itemDefinition=$this.data("definition"),uri=$this.data("uri"),type=$this.data("type"),state=$this.data("state")
;e.preventDefault(),deliveryId&&resultId&&itemDefinition&&(uri={uri:uri,resultId:resultId,itemDefinition:itemDefinition,deliveryUri:deliveryId}),previewerFactory(type,uri,state,{readOnly:!0,fullPage:!0})})}}}),define("taoOutcomeUi/loader/taoOutcomeUi.bundle",function(){}),define("taoOutcomeUi/loader/taoOutcomeUi.min",["taoItems/loader/taoItems.min"],function(){});
//# sourceMappingURL=taoOutcomeUi.min.js.map